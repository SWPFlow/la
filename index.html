<html>
<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11.23/themes/css/cartodb.css" />
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11.23/cartodb.js"></script>
  <script src="vendor/leaflet-hash.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.js"></script>
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
  <![endif]-->
  <style>
    html, body {width:100%; height:100%; padding: 0; margin: 0; background: turquoise;}
    #cartodb-map { width: 100%; height:100%; background: transparent;}
    #label-control {
      font-family: 'Helvetica Neue', Helvetica, sans-serif;
      font-weight: 400;
      font-size: 14px;
      line-height: normal;
      display: block;
    }
  </style>
  <script>
    var map;
    function init(){

      var showLabels = false;

      // Parse query parameters:
      var search_values = location.search.replace('\?','').split('&');
      search_values.forEach(function(param) {
        key_value = param.split("=");
        if (key_value.length == 2) { // skip if it doesn't parse well
          if (key_value[0] == "labels" && key_value[1] == "true") {
            showLabels = true;
          }
          if (key_value[0] == "background" && key_value[1].match(/^\w+$/)) { // make sure no weird characters
            if (d3.color(key_value[1])) { // see if d3 parses it as a CSS color
              d3.select("body").style("background-color", key_value[1]);
            }
            if (d3.color('#' + key_value[1])) { // see if d3 parses it as a hex value
              d3.select("body").style("background-color", '#' + key_value[1]);
            }
          }
        }
      });

      // initiate leaflet map
      map = new L.Map('cartodb-map', { 
        center: [34.0522,-118.2437],
        zoom: 14
      })

      var layerUrl = 'https://stamen.carto.com/u/stamen-org/api/v2/viz/ea17c2c0-961c-11e4-97a4-f23c91504230/viz.json';

      cartodb.createLayer(map, layerUrl, {
        cartodb_logo:false,
      }).addTo(map)
        .on('done', function(layer) {
        }).on('error', function() {
          //log the error
        });

      var labelLayer = L.tileLayer('http://{s}.tile.stamen.com/toner-labels/{z}/{x}/{y}.png', {id: 'labelLayer', zIndex: 100});

      if (showLabels) // off by default
        labelLayer.addTo(map);

      // scale bar
      L.control.scale().addTo(map);

      // Add URL hash for zoom/lat/lon
      var hash = new L.Hash(map);

      map.attributionControl.setPrefix('Map by <a href="http://stamen.com">Stamen Design</a>');

      // Mapzen geocoder
      L.control.geocoder('search-hNyVAbJ').addTo(map);

      d3.select("#label-control")
        .append("label")
          .text("show map labels")
        .append("input")
          .property("checked", showLabels)
          .attr("type", "checkbox")
          .on("change", function(evt) {
            if (this.checked) {
              map.addLayer(labelLayer);
              var location_string = location.href;
              if (location_string.match("labels=false")) {
                history.pushState({},null,location_string.replace("labels=false","labels=true"));
              } else {
                // if it's not in the URL
                // then there might not be a '?' either:
                if (location_string.match("\\?")) // means there's already a search query
                  history.pushState({},null,location_string.replace("#","&labels=true#"));
                else
                  history.pushState({},null,location_string.replace("#","?labels=true#"));
              }
            } else {
              map.removeLayer(labelLayer);
              var location_string = location.href;
              if (location_string.match("labels=true")) {
                history.pushState({},null,location_string.replace("labels=true","labels=false"));
              } else {
                // if it's not in the URL
                // then there might not be a '?' either:
                if (location_string.match("\\?")) // means there's already a search query
                  history.pushState({},null,location_string.replace("#","&labels=false#"));
                else
                  history.pushState({},null,location_string.replace("#","?labels=false#"));
              }
            }

            // update the URL location
            //var location_string = location;
          });
    }
  </script>
</head>
<body onload="init()">

  <!-- copied from the default CARTO overlays -->

  <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 500px; margin-left: 0px; margin-top: 0px; top: 55px; left: 66px; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0.701961);">
    <div class="content">
      <div class="text widget_text" style="z-index: 4; color: rgb(255, 255, 255); text-align: left; font-size: 20px;"><strong>
        Los Angeles buildings and parcels
      </strong></div>
    </div>
  </div>
  <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 300px; margin-left: 0px; margin-top: 0px; top: 119px; left: 66px; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0.701961);">
    <div class="content">
      <div class="text widget_text" style="z-index: 4; color: rgb(255, 255, 255); text-align: left; font-size: 14px;">
        Small buildings are dark, and larger buildings are lighter in color.
        <br>Parcels are the reverse: small parcels are light and larger parcels are darker
      </div>
    </div>
  </div>

  <div class="cartodb-overlay overlay-text desktop content text widget_text" style="z-index: 4; margin-left: 0px; margin-top: 0px; top: 55px; right: 60px; left: auto: bottom: auto; display: block; background-color: rgba(0, 0, 0, 0.701961);">
    <div class="content">
      <div id="label-control" class="text widget_text" style="z-index: 4; color: rgb(255, 255, 255); text-align: left; font-size: 14px;">
      </div>
    </div>
  </div>
  <div id='cartodb-map'></div>
</body>
</html>
